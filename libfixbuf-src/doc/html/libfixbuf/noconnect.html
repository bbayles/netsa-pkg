
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>fixbuf- Documentation</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
        <link rel="stylesheet" type="text/css" href="../../site/style.css" />
        <link rel="stylesheet" type="text/css" href="doxygen.css">
        <link rel="stylesheet" type="text/css" href="tabs.css">
</head>
<body>
    <div id="p-body">
      <div id="l-header">
        <img src="../../site/sei-logo.png" id="l-sei-logo"
            alt="Software Engineering Institute | Carnegie Mellon&copy;" />
        <div id="l-netsa-logo"><a id="l-netsa-name" href="../../index.html"><b>CERT NetSA Security Suite</b></a></div>
        <div id="l-netsa-motto">Monitoring for Large-Scale Networks</div>
        <h1 class="l-page-title">fixbuf</h1>
        <span id="l-subtitle">Documentation</span>
      </div><!-- l-header -->
      <div id="l-content">
        <div id="l-sidebar">
          <div class="p-sidebar-section">
            <h1><a href="../index.html">fixbuf</a></h1>
            <ul>
              <li><a href="index.html">Documentation</a></li>
              <li><a href="../download.html">Downloads</a></li>
	      <li><a href="../../pyfixbuf/index.html">pyfixbuf</a></li>
            </ul>
          </div><!-- p-sidebar-section -->
        </div><!-- l-sidebar -->
      <div id="top"> <!-- need this for doxygen -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Connection-less Collector </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>How-To Use libfixbuf with a Data Buffer</p>
<p>To use fixbuf independent of the transport mode, the application must create an fbInfoModel_t using <a class="el" href="public_8h.html#a390f707c7decf65060f31c0dba6c2a97" title="Allocates a new information model.">fbInfoModelAlloc()</a> and any additional, vendor-specific information elements using <a class="el" href="public_8h.html#ae06a524366afa6827d7e5abb1c33c0d0" title="Adds a single information element to an information model.">fbInfoModelAddElement()</a>, <a class="el" href="public_8h.html#a202bfa2340263229893a38de18670179" title="Adds multiple information elements in an array to an information model.">fbInfoModelAddElementArray()</a>, <a class="el" href="public_8h.html#af72db51fd417df411a82909c5fd5d84d" title="Adds information specified in the given XML file to the information model.">fbInfoModelReadXMLFile()</a>, or <a class="el" href="public_8h.html#a2bbcf6d4a777ed7e0a2c364e0662b9f3" title="Adds information specified in the given XML data to the information model.">fbInfoModelReadXMLData()</a>. Next create an fbSession_t using <a class="el" href="public_8h.html#ace1d8a4523d098e625d5330e0d15bd4b" title="Allocates a transport session state container.">fbSessionAlloc()</a> and add internal templates via <a class="el" href="public_8h.html#a2e4baf6d2142eca4cb526b1e80628bf8" title="Adds a template to a session.">fbSessionAddTemplate()</a>. The application will handle all connections and reading and simply pass fixbuf the buffer to be decoded. The buffer must contain valid IPFIX and should begin with the standard IPFIX header. Ideally, the application should provide the necessary templates before any data records to ensure that the application can decode all of the data records.</p>
<p>The application should NOT create an fbCollector. To create the fBuf, use <a class="el" href="public_8h.html#a71b2a64c7d212e9c3562388b95b993ab" title="Allocates a new buffer for collection.">fBufAllocForCollection()</a> and set the second parameter to NULL. The application then has everything needed to start reading from the IPFIX source. Ideally, the application will read the first 4 bytes of the message first to determine the length of the next IPFIX message. The first 2 bytes are the IPFIX version (0x000A) and the third and fourth bytes are the length of the following IPFIX message (including the IPFIX message header). The application should then continue reading the length of the IPFIX message into an allocated buffer. The buffer should then be set on the fBuf by calling <a class="el" href="public_8h.html#a28f24bbb227eb0f2fdd444c8754d9642" title="Sets a buffer on an fBuf for collection.">fBufSetBuffer()</a>. The application will continue to call <a class="el" href="public_8h.html#a11c40f1d55e2d4b29b40eb4c07ce5ee7" title="Retrieves a record from a Buffer associated with a collecting process.">fBufNext()</a> to receive the data records until <a class="el" href="public_8h.html#a11c40f1d55e2d4b29b40eb4c07ce5ee7" title="Retrieves a record from a Buffer associated with a collecting process.">fBufNext()</a> returns FALSE with error code FB_ERROR_BUFSZ. However, if the fBuf is in manual mode (see <a class="el" href="public_8h.html#a661f4cc21e726345d3e22372af33c2d1" title="Sets the automatic (read/write) mode flag on a buffer.">fBufSetAutomaticMode()</a>) AND the application was reading the message length, fixbuf will first return an FB_ERROR_EOM which will signal to the application to perform another read (if the application ignores FB_ERROR_EOM errors and calls <a class="el" href="public_8h.html#a11c40f1d55e2d4b29b40eb4c07ce5ee7" title="Retrieves a record from a Buffer associated with a collecting process.">fBufNext()</a>, <a class="el" href="public_8h.html#a11c40f1d55e2d4b29b40eb4c07ce5ee7" title="Retrieves a record from a Buffer associated with a collecting process.">fBufNext()</a> will then return FB_ERROR_BUFSZ). This error notifies the application that there is not enough data in the buffer to read a full IPFIX message. If the application only read the size of the IPFIX message, the entire buffer should have been read. However, if the application was reading more than the IPFIX message length, additional data may remain in the buffer that belongs to the next IPFIX message. To determine how much data was left in the buffer unread, <a class="el" href="public_8h.html#aee3090cf1b7d116077bb9b627d622fb1" title="Retrieves the length of the buffer that is remaining after processing.">fBufRemaining()</a> will return the length of the buffer that was not processed. That remaining data should be copied to the beginning of the buffer and the remaining IPFIX message data should be read. After each read, the application needs to call <a class="el" href="public_8h.html#a28f24bbb227eb0f2fdd444c8754d9642" title="Sets a buffer on an fBuf for collection.">fBufSetBuffer()</a>. Note that <a class="el" href="public_8h.html#a28f24bbb227eb0f2fdd444c8754d9642" title="Sets a buffer on an fBuf for collection.">fBufSetBuffer()</a> sets the collector and exporter on the fBuf to NULL. The application should clear the FB_ERROR_BUFSZ and/or FB_ERROR_EOM error when they occur using g_clear_error().</p>
<p>fixbuf may return the following error codes if it encounters one of the below issues. The application should determine the error and respond appropriately.</p>
<ul>
<li>FB_ERROR_IPFIX<ul>
<li>If the first 2 bytes != 0x000A</li>
<li>If the length in the header &lt; 16</li>
</ul>
</li>
<li>FB_ERROR_EOM<ul>
<li>If the application read only the message length and the application called fBufSetAutomaticMode(fbuf, FALSE) (the fBuf is in manual mode). This means the remaining buffer length == 0 and the application should clear the error and perform another read</li>
</ul>
</li>
<li>FB_ERROR_BUFSZ<ul>
<li>If the header message length &gt; the given buffer length</li>
<li>if the given buffer == NULL</li>
<li>If the given buffer length &lt; 16</li>
<li>If buffer length == 0</li>
</ul>
</li>
</ul>
<p>Example usage: </p><div class="fragment"><div class="line">FILE *fp;</div>
<div class="line">uint8_t buf[65535];</div>
<div class="line">...</div>
<div class="line">while (fread(buf, 1, 4, fp) == 4) {</div>
<div class="line">   len = ntohs(*((uint16_t *)(buf+2)));</div>
<div class="line">   rc = fread(buf+4, 1, len-4, fp);</div>
<div class="line">   <span class="keywordflow">if</span> (rc &gt; 0) {</div>
<div class="line">       <a class="code" href="public_8h.html#a28f24bbb227eb0f2fdd444c8754d9642">fBufSetBuffer</a>(fbuf, buf, rc+4);</div>
<div class="line">   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (feof(fp))</div>
<div class="line">   ....</div>
<div class="line">   <span class="keywordflow">for</span> (;;) {</div>
<div class="line">       ret = <a class="code" href="public_8h.html#a11c40f1d55e2d4b29b40eb4c07ce5ee7">fBufNext</a>(fbuf, (uint8_t *)rec, &amp;len, &amp;err);</div>
<div class="line">       <span class="keywordflow">if</span> (FALSE == ret) {</div>
<div class="line">          <span class="keywordflow">if</span> (g_error_matches(err, <a class="code" href="public_8h.html#a16875886e559694c2a5d80cc1b9e00de">FB_ERROR_DOMAIN</a>, <a class="code" href="public_8h.html#a2e0ffd43c861a9833b279557d687c57a">FB_ERROR_BUFSZ</a>)){</div>
<div class="line">             rem = <a class="code" href="public_8h.html#aee3090cf1b7d116077bb9b627d622fb1">fBufRemaining</a>(fbuf);</div>
<div class="line">             g_clear_error(&amp;err);</div>
<div class="line">             <span class="keywordflow">break</span>;</div>
<div class="line">          }</div>
<div class="line">       }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="apublic_8h_html_a28f24bbb227eb0f2fdd444c8754d9642"><div class="ttname"><a href="public_8h.html#a28f24bbb227eb0f2fdd444c8754d9642">fBufSetBuffer</a></div><div class="ttdeci">void fBufSetBuffer(fBuf_t *fbuf, uint8_t *buf, size_t buflen)</div><div class="ttdoc">Sets a buffer on an fBuf for collection.</div></div>
<div class="ttc" id="apublic_8h_html_a2e0ffd43c861a9833b279557d687c57a"><div class="ttname"><a href="public_8h.html#a2e0ffd43c861a9833b279557d687c57a">FB_ERROR_BUFSZ</a></div><div class="ttdeci">#define FB_ERROR_BUFSZ</div><div class="ttdoc">A message was received larger than the collector buffer size.</div><div class="ttdef"><b>Definition:</b> public.h:1173</div></div>
<div class="ttc" id="apublic_8h_html_aee3090cf1b7d116077bb9b627d622fb1"><div class="ttname"><a href="public_8h.html#aee3090cf1b7d116077bb9b627d622fb1">fBufRemaining</a></div><div class="ttdeci">size_t fBufRemaining(fBuf_t *fbuf)</div><div class="ttdoc">Retrieves the length of the buffer that is remaining after processing.</div></div>
<div class="ttc" id="apublic_8h_html_a16875886e559694c2a5d80cc1b9e00de"><div class="ttname"><a href="public_8h.html#a16875886e559694c2a5d80cc1b9e00de">FB_ERROR_DOMAIN</a></div><div class="ttdeci">#define FB_ERROR_DOMAIN</div><div class="ttdoc">All fixbuf errors are returned within the FB_ERROR_DOMAIN domain.</div><div class="ttdef"><b>Definition:</b> public.h:1149</div></div>
<div class="ttc" id="apublic_8h_html_a11c40f1d55e2d4b29b40eb4c07ce5ee7"><div class="ttname"><a href="public_8h.html#a11c40f1d55e2d4b29b40eb4c07ce5ee7">fBufNext</a></div><div class="ttdeci">gboolean fBufNext(fBuf_t *fbuf, uint8_t *recbase, size_t *recsize, GError **err)</div><div class="ttdoc">Retrieves a record from a Buffer associated with a collecting process.</div></div>
      </div><!-- l-content -->
      <div id="l-footer">
        &copy; 2006-2020 Carnegie Mellon University
        <span id="l-contact">
          <a href="https://www.sei.cmu.edu/legal/index.cfm">Legal</a> |
          <a href="https://www.sei.cmu.edu/legal/privacy-notice/index.cfm">Privacy Notice</a> |
          <img alt="email address" src="/site/contact_email.png" />
        </span>
      </div>
    </div><!-- p-body -->
</body>
</html>
